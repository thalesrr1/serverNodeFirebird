<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebird API Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-mono {
            font-family: 'Fira Code', monospace;
        }
        .method-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .method-get { background-color: #3b82f6; color: white; }
        .method-post { background-color: #16a34a; color: white; }
        .method-put { background-color: #f97316; color: white; }
        .method-delete { background-color: #dc2626; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 256 256"><path fill="#f97316" d="M232 128a104 104 0 0 1-182.2 68.3a8 8 0 0 1 4.4-14.8a88.1 88.1 0 1 0-26.4-91.8a8 8 0 0 1-14.8-4.4A104 104 0 0 1 232 128Z"/><path fill="#f97316" d="M128 24a104.2 104.2 0 0 0-96.9 68.3a8 8 0 0 0 4.4 14.8a88.1 88.1 0 0 1 185 18.7a8 8 0 0 0 9-6.8A104.1 104.1 0 0 0 128 24Zm40 88a16 16 0 1 1-16-16a16 16 0 0 1 16 16Z"/></svg>
                <h1 class="text-xl font-bold text-white">Firebird API Gateway</h1>
            </div>
            <div id="connection-status-header" class="flex items-center space-x-2 text-sm">
                <!-- Status da conexão será inserido aqui -->
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8">

        <!-- ===== Tela de Conexão ===== -->
        <div id="connect-screen" class="flex flex-col items-center justify-center h-full">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-700">
                <h2 class="text-2xl font-bold text-center mb-6 text-white">Conectar ao Banco de Dados</h2>
                <form id="connect-form" class="space-y-4">
                    <div>
                        <label for="host" class="block text-sm font-medium text-gray-400">Host</label>
                        <input type="text" id="host" value="localhost" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="port" class="block text-sm font-medium text-gray-400">Port</label>
                        <input type="number" id="port" value="3050" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-400">User</label>
                        <input type="text" id="username" value="SYSDBA" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-400">Password</label>
                        <input type="password" id="password" value="masterkey" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="database" class="block text-sm font-medium text-gray-400">Database Path</label>
                        <input type="text" id="database" value="D:\UpSystem\Dados\DADOS.FDB" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" id="connect-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition-colors">
                        Conectar
                    </button>
                </form>
                <div id="connect-status" class="mt-4 text-center text-sm text-gray-500">
                    Status: Desconectado
                </div>
            </div>
        </div>

        <!-- ===== Tela de Endpoints ===== -->
        <div id="endpoints-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Endpoints</h2>
                <button id="open-create-modal-btn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>Criar Endpoint</span>
                </button>
            </div>
            <div id="endpoints-list" class="bg-gray-800/50 border border-gray-700 rounded-lg shadow-lg overflow-hidden">
                <!-- Lista de endpoints será inserida aqui -->
            </div>
        </div>

        <!-- ===== Tela de Teste ===== -->
        <div id="test-screen" class="hidden">
             <div class="flex items-center mb-6">
                <button id="back-to-endpoints-btn" class="mr-4 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <h2 class="text-3xl font-bold text-white">Testar Endpoint</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Painel de Request -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Request</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-400">Método</label>
                            <p id="test-method" class="font-mono text-lg"></p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-400">URL</label>
                            <p id="test-url" class="font-mono text-lg text-orange-400"></p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-400">SQL Query</label>
                            <pre class="bg-gray-900 p-3 rounded-md overflow-x-auto"><code id="test-sql" class="font-mono text-sm text-cyan-300"></code></pre>
                        </div>
                    </div>
                    <button id="execute-query-btn" class="mt-6 w-full flex justify-center items-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <span>Executar Query</span>
                    </button>
                </div>
                <!-- Painel de Response -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="text-xl font-semibold">Response</h3>
                         <button id="copy-response-btn" class="hidden text-gray-400 hover:text-white transition-colors" title="Copiar JSON">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                         </button>
                    </div>
                    <div id="response-container" class="bg-gray-900 p-3 rounded-md h-96 overflow-auto">
                        <div id="response-placeholder" class="flex items-center justify-center h-full text-gray-500">
                            Clique em 'Executar Query' para ver o resultado.
                        </div>
                        <pre><code id="response-content" class="font-mono text-sm"></code></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Criação de Endpoint -->
    <div id="create-endpoint-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 w-full max-w-2xl rounded-lg shadow-xl p-8 border border-gray-700">
            <h3 class="text-2xl font-bold mb-6 text-white">Criar Novo Endpoint</h3>
            <form id="create-endpoint-form" class="space-y-4">
                <div>
                    <label for="endpoint-name" class="block text-sm font-medium text-gray-400">Nome do Endpoint</label>
                    <input type="text" id="endpoint-name" placeholder="ex: obtemProdutos" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="endpoint-method" class="block text-sm font-medium text-gray-400">Método HTTP</label>
                    <select id="endpoint-method" class="mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option>GET</option>
                        <option>POST</option>
                        <option>PUT</option>
                        <option>DELETE</option>
                    </select>
                </div>
                <div>
                    <label for="endpoint-sql" class="block text-sm font-medium text-gray-400">SQL Query</label>
                    <textarea id="endpoint-sql" rows="6" placeholder="SELECT * FROM PRODUTOS" class="font-mono mt-1 block w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="close-create-modal-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-gray-800 w-full max-w-md rounded-lg shadow-xl p-8 border border-gray-700">
            <h3 class="text-xl font-bold mb-4 text-white">Confirmar Exclusão</h3>
            <p class="text-gray-300 mb-6">Tem certeza que deseja excluir o endpoint <strong id="endpoint-to-delete-name" class="font-mono"></strong>?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Container de Notificações (Toast) -->
    <div id="notification-container" class="fixed bottom-5 right-5 space-y-3 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuração da API ---
            const API_BASE_URL = 'http://localhost:3000'; // URL do seu backend

            // --- Gerenciamento de Estado Simples ---
            let state = {
                currentScreen: 'connect', // 'connect', 'endpoints', 'test'
                dbConfig: null,
                endpoints: [],
                selectedEndpoint: null,
                endpointToDelete: null,
                isLoading: false,
            };

            // --- Seletores de DOM ---
            const screens = {
                connect: document.getElementById('connect-screen'),
                endpoints: document.getElementById('endpoints-screen'),
                test: document.getElementById('test-screen'),
            };

            const connectForm = document.getElementById('connect-form');
            const connectBtn = document.getElementById('connect-btn');
            const connectStatus = document.getElementById('connect-status');
            const connectionStatusHeader = document.getElementById('connection-status-header');

            const endpointsList = document.getElementById('endpoints-list');
            const openCreateModalBtn = document.getElementById('open-create-modal-btn');

            const createModal = document.getElementById('create-endpoint-modal');
            const createForm = document.getElementById('create-endpoint-form');
            const closeModalBtn = document.getElementById('close-create-modal-btn');

            const deleteModal = document.getElementById('delete-confirm-modal');
            const endpointToDeleteName = document.getElementById('endpoint-to-delete-name');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            const backToEndpointsBtn = document.getElementById('back-to-endpoints-btn');
            const testMethod = document.getElementById('test-method');
            const testUrl = document.getElementById('test-url');
            const testSql = document.getElementById('test-sql');
            const executeQueryBtn = document.getElementById('execute-query-btn');
            const responseContainer = document.getElementById('response-container');
            const responseContent = document.getElementById('response-content');
            const responsePlaceholder = document.getElementById('response-placeholder');
            const copyResponseBtn = document.getElementById('copy-response-btn');

            // --- Funções de Renderização ---
            const renderScreen = () => {
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                screens[state.currentScreen].classList.remove('hidden');
                updateHeader();
            };

            const updateHeader = () => {
                if (state.dbConfig) {
                    const dbName = state.dbConfig.database.split(/[\\/]/).pop();
                    connectionStatusHeader.innerHTML = `
                        <span class="flex h-3 w-3 relative">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        <span class="text-green-400">Conectado:</span>
                        <span class="font-semibold text-white">${dbName}</span>
                        <button id="disconnect-btn" class="ml-2 text-red-500 hover:text-red-400 font-semibold text-xs">[Desconectar]</button>
                    `;
                    document.getElementById('disconnect-btn').addEventListener('click', handleDisconnect);
                } else {
                    connectionStatusHeader.innerHTML = `
                        <span class="flex h-3 w-3 relative">
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                        </span>
                        <span class="text-red-400">Desconectado</span>
                    `;
                }
            };
            
            const setLoading = (button, isLoading) => {
                state.isLoading = isLoading;
                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processando...
                    `;
                } else {
                    button.disabled = false;
                    // O texto original será restaurado pelos chamadores
                }
            };
            
            const renderEndpoints = () => {
                if (state.endpoints.length === 0) {
                    endpointsList.innerHTML = `<div class="text-center p-8 text-gray-500">Nenhum endpoint encontrado. Clique em 'Criar Endpoint' para começar.</div>`;
                    return;
                }

                endpointsList.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Método</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nome</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">URL</th>
                                <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800/50 divide-y divide-gray-700">
                            ${state.endpoints.map(ep => `
                                <tr class="hover:bg-gray-700/50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap"><span class="method-tag method-${ep.method.toLowerCase()}">${ep.method}</span></td>
                                    <td class="px-6 py-4 whitespace-nowrap font-medium text-white">${ep.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap font-mono text-orange-400">/dynamic/${ep.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                        <button data-testid="${ep.id}" class="test-btn text-blue-400 hover:text-blue-300 transition-colors">Testar</button>
                                        <button data-deleteid="${ep.id}" data-deletename="${ep.name}" class="delete-btn text-red-500 hover:text-red-400 transition-colors">Excluir</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.querySelectorAll('.test-btn').forEach(btn => btn.addEventListener('click', (e) => handleTestEndpoint(e.target.dataset.testid)));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => openDeleteModal(e.target.dataset.deleteid, e.target.dataset.deletename)));
            };
            
            const renderTestScreen = () => {
                if (!state.selectedEndpoint) return;
                const { method, name, sql } = state.selectedEndpoint;
                testMethod.textContent = method;
                testMethod.className = `method-tag method-${method.toLowerCase()}`;
                testUrl.textContent = `/dynamic/${name}`;
                testSql.textContent = sql;
                responsePlaceholder.classList.remove('hidden');
                responseContent.textContent = '';
                copyResponseBtn.classList.add('hidden');
            };

            // --- Funções de Notificação ---
            const showNotification = (message, type = 'success') => {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500'
                };
                const notif = document.createElement('div');
                notif.className = `p-4 rounded-lg shadow-lg text-white ${colors[type]} transform transition-all duration-300 translate-x-full`;
                notif.textContent = message;
                
                document.getElementById('notification-container').appendChild(notif);
                
                setTimeout(() => {
                    notif.classList.remove('translate-x-full');
                }, 10);

                setTimeout(() => {
                    notif.classList.add('translate-x-full');
                    setTimeout(() => notif.remove(), 300);
                }, 4000);
            };

            // --- Funções de Lógica e API ---
            const handleConnectFormSubmit = async (e) => {
                e.preventDefault();
                setLoading(connectBtn, true);
                connectStatus.textContent = "Status: Conectando...";

                const formData = {
                    host: document.getElementById('host').value,
                    port: parseInt(document.getElementById('port').value, 10),
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    database: document.getElementById('database').value,
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/config/connect`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.details || data.error || 'Falha na conexão');
                    }
                    
                    state.dbConfig = data.config;
                    connectStatus.textContent = "Status: Conectado com sucesso!";
                    connectStatus.classList.add('text-green-400');
                    showNotification('Conectado com sucesso!', 'success');
                    
                    await fetchEndpoints();
                    state.currentScreen = 'endpoints';
                    renderScreen();

                } catch (error) {
                    console.error('Connection error:', error);
                    connectStatus.textContent = `Erro: ${error.message}`;
                    connectStatus.classList.remove('text-green-400');
                    connectStatus.classList.add('text-red-400');
                    showNotification(`Erro de conexão: ${error.message}`, 'error');
                } finally {
                    setLoading(connectBtn, false);
                    connectBtn.textContent = 'Conectar';
                }
            };
            
            const handleDisconnect = () => {
                state.dbConfig = null;
                state.endpoints = [];
                state.currentScreen = 'connect';
                connectForm.reset();
                connectStatus.textContent = 'Status: Desconectado';
                connectStatus.className = 'mt-4 text-center text-sm text-gray-500';
                renderScreen();
                showNotification('Desconectado.', 'info');
            };

            const fetchEndpoints = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/endpoints`);
                    if (!response.ok) throw new Error('Falha ao buscar endpoints');
                    state.endpoints = await response.json();
                    renderEndpoints();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            };
            
            const handleCreateEndpoint = async (e) => {
                e.preventDefault();
                const endpointData = {
                    name: document.getElementById('endpoint-name').value,
                    method: document.getElementById('endpoint-method').value,
                    sql: document.getElementById('endpoint-sql').value,
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/endpoints`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(endpointData)
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.details || data.error);
                    
                    showNotification('Endpoint criado com sucesso!', 'success');
                    createModal.classList.add('hidden');
                    createForm.reset();
                    await fetchEndpoints();

                } catch (error) {
                    showNotification(`Erro ao criar: ${error.message}`, 'error');
                }
            };

            const openDeleteModal = (id, name) => {
                state.endpointToDelete = id;
                endpointToDeleteName.textContent = name;
                deleteModal.classList.remove('hidden');
            };
            
            const handleDeleteEndpoint = async () => {
                if (!state.endpointToDelete) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/api/endpoints/${state.endpointToDelete}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);

                    showNotification('Endpoint excluído com sucesso!', 'success');
                    deleteModal.classList.add('hidden');
                    state.endpointToDelete = null;
                    await fetchEndpoints();
                } catch (error) {
                    showNotification(`Erro ao excluir: ${error.message}`, 'error');
                }
            };

            const handleTestEndpoint = (id) => {
                state.selectedEndpoint = state.endpoints.find(ep => ep.id === id);
                state.currentScreen = 'test';
                renderTestScreen();
                renderScreen();
            };
            
            const handleExecuteQuery = async () => {
                if (!state.selectedEndpoint) return;
                setLoading(executeQueryBtn, true);
                responsePlaceholder.classList.remove('hidden');
                responseContent.textContent = '';
                responseContent.className = 'font-mono text-sm';
                copyResponseBtn.classList.add('hidden');

                const { name, method } = state.selectedEndpoint;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/dynamic/${name}`, { method });
                    const data = await response.json();
                    
                    responsePlaceholder.classList.add('hidden');
                    if (response.ok) {
                        responseContent.textContent = JSON.stringify(data, null, 2);
                        responseContent.classList.add('text-green-300');
                        copyResponseBtn.classList.remove('hidden');
                    } else {
                        throw new Error(JSON.stringify(data, null, 2));
                    }
                } catch (error) {
                    responsePlaceholder.classList.add('hidden');
                    responseContent.textContent = error.message;
                    responseContent.classList.add('text-red-400');
                } finally {
                    setLoading(executeQueryBtn, false);
                    executeQueryBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <span>Executar Query</span>`;
                }
            };
            
            const handleCopyResponse = () => {
                const textToCopy = responseContent.textContent;
                // Usando o método execCommand para compatibilidade com iframes
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('JSON copiado para a área de transferência!', 'success');
                } catch (err) {
                    showNotification('Falha ao copiar JSON.', 'error');
                }
                document.body.removeChild(textArea);
            };

            // --- Event Listeners ---
            connectForm.addEventListener('submit', handleConnectFormSubmit);
            
            openCreateModalBtn.addEventListener('click', () => createModal.classList.remove('hidden'));
            closeModalBtn.addEventListener('click', () => createModal.classList.add('hidden'));
            createForm.addEventListener('submit', handleCreateEndpoint);

            cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
            confirmDeleteBtn.addEventListener('click', handleDeleteEndpoint);
            
            backToEndpointsBtn.addEventListener('click', () => {
                state.currentScreen = 'endpoints';
                renderScreen();
            });
            executeQueryBtn.addEventListener('click', handleExecuteQuery);
            copyResponseBtn.addEventListener('click', handleCopyResponse);

            // --- Inicialização ---
            const init = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/config/current`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.config) {
                            state.dbConfig = data.config;
                            await fetchEndpoints();
                            state.currentScreen = 'endpoints';
                        }
                    }
                } catch (error) {
                    console.log("Servidor backend possivelmente offline. Iniciando na tela de conexão.");
                } finally {
                    renderScreen();
                }
            };

            init();
        });
    </script>
</body>
</html>
